esphome:
  name: boilercontrol
  friendly_name: BoilerControl

esp32:
  board: esp32dev
  framework:
    type: esp-idf

# Enable logging
logger:
  level: DEBUG

# Enable Home Assistant API
api:
  encryption:
    key: "FpSU4uWfdjSNc0dAxtMGojEgLKCgl6bhTWJxpMT6mXE="
  reboot_timeout: 0s  # Don't reboot on API timeout
  # Failsafe: If connection to HA is lost for 15+ minutes, activate failsafe
  on_client_disconnected:
    - lambda: |-
        // Mark as disconnected (only if we had a connection)
        if (id(ha_connected)) {
          ESP_LOGI("api", "HA connection lost - failsafe will activate in 15 minutes if not reconnected");
          id(ha_connected) = false;
        }
    - delay: 15min
    - lambda: |-
        // Only activate failsafe if still disconnected after 15 minutes
        if (!id(ha_connected) && !id(failsafe_active)) {
          ESP_LOGI("api", "HA connection lost for 15+ minutes - activating failsafe (relay 1 on)");
          // Save current relay 1 state before failsafe
          id(relay_1_pre_failsafe_state) = id(relay_1).state;
          id(failsafe_active) = true;
          id(relay_1).turn_on();
        }
  on_client_connected:
    - lambda: |-
        ESP_LOGI("api", "HA connection established");
        // Mark as connected
        id(ha_connected) = true;
        
        // If failsafe was active, restore previous state
        if (id(failsafe_active)) {
          ESP_LOGI("api", "Restoring relay 1 to pre-failsafe state: %s", id(relay_1_pre_failsafe_state) ? "ON" : "OFF");
          if (id(relay_1_pre_failsafe_state)) {
            id(relay_1).turn_on();
          } else {
            id(relay_1).turn_off();
          }
          id(failsafe_active) = false;
        }

ota:
  - platform: esphome
    password: "b5238b88692d6b7e4aa3ee4377c8f76b"

# WiFi configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: NONE
  fast_connect: false
  reboot_timeout: 0s
  manual_ip:
    static_ip: 192.168.1.35
    gateway: 192.168.1.1
    subnet: 255.255.255.0
  

# Bluetooth Proxy (extends Home Assistant BLE range)
# DISABLED: Causes frequent API disconnections on this device
# Uncomment if you need BLE proxy functionality and can tolerate brief disconnects
# bluetooth_proxy:
#   active: true

# Global to track button press state (0=all off, 1=relay1 on, 2=both on)
globals:
  - id: relay_state
    type: int
    restore_value: no
    initial_value: "0"
  
  # Track relay 1 state before failsafe activation
  - id: relay_1_pre_failsafe_state
    type: bool
    restore_value: no
    initial_value: "false"
  
  # Track if failsafe is currently active
  - id: failsafe_active
    type: bool
    restore_value: no
    initial_value: "false"
  
  # Track if HA is connected (used to prevent delayed action executing after reconnect)
  - id: ha_connected
    type: bool
    restore_value: no
    initial_value: "false"

# LED controlled by relay states
output:
  - platform: gpio
    pin: GPIO2
    id: status_led_output
    inverted: true

light:
  - platform: binary
    name: "Status LED"
    id: status_led
    output: status_led_output
    internal: true

# Relay 1 - Typically used for boiler/heating control
switch:
  - platform: gpio
    name: "Boiler Relay 1"
    id: relay_1
    pin: GPIO16
    inverted: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:water-boiler"
    on_turn_on:
      - logger.log: "Relay 1 turned ON"
      - light.turn_on: status_led
    on_turn_off:
      - logger.log: "Relay 1 turned OFF"
      - lambda: |-
          // Only turn off LED if both relays are off
          if (!id(relay_2).state) {
            id(status_led).turn_off();
          }

  # Relay 2 - Secondary control
  - platform: gpio
    name: "Boiler Relay 2"
    id: relay_2
    pin: GPIO17
    inverted: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:water-boiler"
    on_turn_on:
      - logger.log: "Relay 2 turned ON"
      - light.turn_on: status_led
    on_turn_off:
      - logger.log: "Relay 2 turned OFF"
      - lambda: |-
          // Only turn off LED if both relays are off
          if (!id(relay_1).state) {
            id(status_led).turn_off();
          }

# Programmable button (GPIO0) - cycles relays through states
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO0
      mode:
        input: true
        pullup: true
      inverted: true
    name: "Control Button"
    id: control_button
    internal: true
    filters:
      - delayed_on: 10ms
      - delayed_off: 10ms
    on_press:
      - lambda: |-
          // Cycle through states: 0 (all off) -> 1 (relay1 on) -> 2 (both on) -> 0
          id(relay_state) = (id(relay_state) + 1) % 3;
          
          ESP_LOGI("button", "Button pressed, new state: %d", id(relay_state));
          
          if (id(relay_state) == 0) {
            // All off
            id(relay_1).turn_off();
            id(relay_2).turn_off();
          } else if (id(relay_state) == 1) {
            // Relay 1 ON, Relay 2 OFF
            id(relay_1).turn_on();
            id(relay_2).turn_off();
          } else if (id(relay_state) == 2) {
            // Both ON
            id(relay_1).turn_on();
            id(relay_2).turn_on();
          }

# Restart button (accessible from Home Assistant)
button:
  - platform: restart
    name: "Boiler Control Restart"
